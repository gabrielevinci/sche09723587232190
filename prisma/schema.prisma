generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  name              String
  email             String             @unique
  password          String
  isActive          Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  isAdmin           Boolean            @default(false)
  timezone          String             @default("Europe/Rome") // IANA timezone (es: Europe/Rome, America/New_York)
  adminAssociations AdminAssociation[]
  socialAccounts    SocialAccount[]
  scheduledPosts    ScheduledPost[]

  @@map("users")
}

model SocialAccount {
  id                String             @id @default(cuid())
  platform          String
  accountName       String
  accountId         String             @unique  // ID OnlySocial (pu√≤ essere numerico o stringa)
  accountUuid       String?            // UUID OnlySocial API
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userId            String?
  adminAssociations AdminAssociation[]
  user              User?              @relation(fields: [userId], references: [id])

  @@map("social_accounts")
}

model AdminAssociation {
  id              String        @id @default(cuid())
  userId          String
  socialAccountId String
  assignedAt      DateTime      @default(now())
  assignedBy      String
  isActive        Boolean       @default(true)
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, socialAccountId])
  @@map("admin_associations")
}

model ScheduledPost {
  id                 String     @id @default(cuid())
  userId             String
  socialAccountId    String
  
  // OnlySocial Account Info
  accountUuid        String?    // UUID dell'account su OnlySocial API
  accountId          Int?       // ID numerico dell'account su OnlySocial API
  
  // Video (supporto per array multipli)
  videoUrls          String[]   @default([])  // Array di URL video su DigitalOcean Spaces
  videoFilenames     String[]   @default([])  // Array di nomi file originali
  videoSizes         Int[]      @default([])  // Array di dimensioni file in bytes
  
  // Contenuto
  caption            String
  postType           String     @default("reel")  // 'post', 'reel', 'story'
  
  // Scheduling (TUTTI GLI ORARI SONO IN FORMATO ITALIANO - Europe/Rome, UTC+1)
  scheduledFor       DateTime   // Data/ora schedulazione in formato italiano
  timezone           String     @default("Europe/Rome")  // Timezone fisso italiano (IANA)
  
  // Stati del processo
  status             PostStatus @default(PENDING)
  publishedAt        DateTime?  // Data/ora pubblicazione in formato italiano
  
  // Error handling
  errorMessage       String?
  retryCount         Int        @default(0)
  maxRetries         Int        @default(3)
  
  // Audit (gestiti manualmente per orario italiano)
  createdAt          DateTime
  updatedAt          DateTime
  
  // Relations
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([scheduledFor])
  @@index([userId])
  @@index([socialAccountId])
  @@index([status, scheduledFor])
  @@map("scheduled_posts")
}

enum PostStatus {
  PENDING           // In attesa di pubblicazione
  MEDIA_UPLOADED    // Media caricato su OnlySocial, in attesa di schedulazione
  SCHEDULED         // Schedulato su OnlySocial
  PUBLISHED         // Pubblicato con successo
  FAILED            // Errore durante pubblicazione
  CANCELLED         // Cancellato dall'utente
}
